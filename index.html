<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>YEĞİTEK Okul Sorumlusu Evrakları Filtreleme</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .filters { margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 5px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        select { min-width: 260px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        #results { margin-top: 16px; overflow-x: auto; max-height: 70vh; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; font-size: 14px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        thead th { background-color: #007bff; color: white; position: sticky; top: 0; z-index: 2; }
        tr:nth-child(even) td { background-color: #f8f9fa; }
        .table-link { color: #007bff; text-decoration: underline; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .home-button { padding: 10px 18px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; }
        .refresh-btn { padding:8px 12px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer; }
        .small { font-size:13px; color:#555; }
        .header-container { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px; flex-wrap:wrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1>YEĞİTEK Okul Sorumlusu Evrakları Filtreleme</h1>
            <div style="display:flex; gap:10px; align-items:center;">
                <button id="refreshBtn" class="refresh-btn">Verileri Güncelle</button>
                <a class="home-button" href="https://atilaerkek.github.io/" target="_blank" rel="noopener noreferrer">Ana Sayfa</a>
            </div>
        </div>

        <div class="filters">
            <label for="teacherSelect">Okul Sorumlusu Seçiniz:</label>
            <select id="teacherSelect"><option value="">Tüm Okul Sorumluları</option></select>

            <div style="margin-left:auto; text-align:right;">
                <div class="small">Son güncelleme: <span id="lastUpdated">—</span></div>
                <div class="small" id="rowCount">Satır: 0</div>
            </div>
        </div>

        <div id="results"><!-- tablo buraya gelecek --></div>
    </div>

    <script>
    // ========== AYAR ==========
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXqYCt6oaKrDvJh6AylhGT7vj70FTC5V1RbWQP2jsVnTnc1VJoQcHH2DVV17mUckuSY9PO2gfbFRGk/pub?output=csv';
    let allData = [];
    let autoRefreshId = null;
    const autoRefreshSeconds = 60; // otomatik yenileme aralığı

    // DOM
    const teacherSelect = document.getElementById('teacherSelect');
    const resultsDiv = document.getElementById('results');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const rowCountEl = document.getElementById('rowCount');
    const refreshBtn = document.getElementById('refreshBtn');

    // Normalizasyon: BOM, NBSP, fazla boşluk kaldır
    function normalizeHeader(s) {
        if (!s && s !== '') return '';
        return String(s).replace(/^\uFEFF/, '').replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim().toLowerCase();
    }

    // Ad Soyad sütununu esnek bulma (farklı yazımlar için)
    function findNameKeyFromHeaders(headers) {
        const normalized = headers.map(h => ({ orig: h, norm: normalizeHeader(h) }));
        // 1) doğrudan eşleşme aranan terimler
        const targets = ['adı soyadı', 'ad soyad', 'adısoyadı', 'ad_soyad', 'adi soyad', 'adsoyad', 'ad', 'isim', 'öğretmen'];
        for (let t of targets) {
            const found = normalized.find(x => x.norm === t);
            if (found) return found.orig;
        }
        // 2) içerik bazlı arama (hem "ad" hem "soy" içeriyorsa)
        for (let x of normalized) {
            if (x.norm.includes('ad') && x.norm.includes('soy')) return x.orig;
        }
        // 3) kısmi eşleşme: "ad" veya "isim" ya da "öğretmen"
        for (let x of normalized) {
            if (x.norm.includes('isim') || x.norm.includes('öğretmen') || x.norm === 'ad') return x.orig;
        }
        return null;
    }

    // Eğer findNameKeyFromHeaders başarısız olursa, veri örneklerine bakarak tahmin et
    function guessNameKeyByHeuristic(data) {
        if (!Array.isArray(data) || data.length === 0) return null;
        const headers = Object.keys(data[0]);
        const nameRegex = /^[\p{L}\s.'-]+$/u; // yalnızca harf, boşluk, nokta, tek tırnak, tire (iyi bir isim göstergesi)
        const scores = headers.map(h => {
            let count = 0;
            for (let i = 0; i < Math.min(100, data.length); i++) {
                const v = String(data[i][h] || '').trim();
                if (!v) continue;
                // URL/telefon/numara gibi olmayan, harf ağırlıklı kısa metinler puan alır
                if (nameRegex.test(v) && v.length < 60 && !v.includes(',')) count++;
            }
            return { header: h, score: count };
        });
        scores.sort((a,b)=> b.score - a.score);
        if (scores.length && scores[0].score >= 3) return scores[0].header; // yeterli eşleşme varsa al
        return null;
    }

    // Delimiter tespiti
    function detectDelimiter(text) {
        const firstLine = (text.split(/\r\n|\n|\r/)[0] || '');
        const commaCount = (firstLine.match(/,/g) || []).length;
        const semiCount = (firstLine.match(/;/g) || []).length;
        return semiCount > commaCount ? ';' : ',';
    }

    // Güçlü CSV ayrıştırıcı (tırnak içi virgül/satır sonu desteği)
    function parseCSV(csvText) {
        if (!csvText) return [];
        const delim = detectDelimiter(csvText);
        const rows = [];
        let cur = '';
        let row = [];
        let inQuotes = false;
        for (let i=0; i<csvText.length; i++) {
            const ch = csvText[i];
            const next = csvText[i+1] || '';
            if (ch === '"') {
                if (inQuotes && next === '"') { cur += '"'; i++; continue; } // escaped quote
                inQuotes = !inQuotes;
                continue;
            }
            if (!inQuotes && ch === delim) {
                row.push(cur);
                cur = '';
                continue;
            }
            if (!inQuotes && ch === '\n') {
                row.push(cur);
                rows.push(row);
                row = [];
                cur = '';
                continue;
            }
            if (!inQuotes && ch === '\r') {
                // ignore, handled by \n
                continue;
            }
            cur += ch;
        }
        // son alan/ satır
        if (cur !== '' || row.length > 0) {
            row.push(cur);
            rows.push(row);
        }
        if (!rows.length) return [];

        // headers
        const rawHeaders = rows.shift().map(h => String(h || '').replace(/^\uFEFF/, '').replace(/\u00A0/g,' ').trim());
        const result = rows.map(r => {
            const obj = {};
            for (let i=0; i<rawHeaders.length; i++) {
                const key = rawHeaders[i] || ('col' + i);
                let v = r[i] !== undefined ? r[i] : '';
                v = String(v).trim();
                if (v.startsWith('"') && v.endsWith('"')) v = v.slice(1,-1);
                obj[key] = v;
            }
            return obj;
        });
        return result;
    }

    // URL kontrol / gösterim
    function isValidURL(s) {
        if (!s) return false;
        const v = String(s).trim();
        return v.startsWith('http://') || v.startsWith('https://') || v.startsWith('www.');
    }
    function formatUrlDisplay(url) {
        try {
            let u = String(url).trim();
            if (u.startsWith('www.')) u = 'https://' + u;
            const o = new URL(u);
            let domain = o.hostname.replace(/^www\./,'');
            let path = (o.pathname + (o.search||'')).substring(0, 30);
            if ((o.pathname + (o.search||'')).length > 30) path += '...';
            return domain + path;
        } catch (e) {
            const s = String(url);
            return s.length > 30 ? s.substring(0,30) + '...' : s;
        }
    }

    // Tablo gösterimi
    function displayData(data) {
        if (!Array.isArray(data) || data.length === 0) {
            resultsDiv.innerHTML = '<p>Veri bulunamadı.</p>';
            return;
        }
        const headers = Object.keys(data[0]);
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        for (let h of headers) {
            const th = document.createElement('th');
            th.textContent = h;
            headRow.appendChild(th);
        }
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.forEach(row => {
            const tr = document.createElement('tr');
            for (let h of headers) {
                const td = document.createElement('td');
                const v = row[h] || '';
                if (isValidURL(v)) {
                    let href = v.trim();
                    if (href.startsWith('www.')) href = 'https://' + href;
                    const a = document.createElement('a');
                    a.href = href;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    a.className = 'table-link';
                    a.title = v;
                    a.textContent = formatUrlDisplay(v);
                    td.appendChild(a);
                } else {
                    td.textContent = v;
                }
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        resultsDiv.innerHTML = '';
        resultsDiv.appendChild(table);
    }

    // Öğretmen/Okul Sorumlusu dropdown doldurma (seçimi korur)
    function populateTeacherSelect(preservedValue) {
        teacherSelect.innerHTML = '<option value="">Tüm Okul Sorumluları</option>';
        if (!allData || allData.length === 0) return;

        // header list
        const headers = Object.keys(allData[0]);
        let nameKey = findNameKeyFromHeaders(headers);
        if (!nameKey) nameKey = guessNameKeyByHeuristic(allData);
        // Eğer hala yoksa, son çare ilk header'ı al
        if (!nameKey) nameKey = headers[0];

        // benzersiz, trimlenmiş, boş olmayan isimler
        const set = new Set();
        for (let r of allData) {
            const raw = String(r[nameKey] || '').trim();
            if (raw) set.add(raw);
        }
        const arr = Array.from(set).sort((a,b)=> a.localeCompare(b, 'tr'));
        arr.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            teacherSelect.appendChild(opt);
        });
        if (preservedValue) {
            // restore if exists
            const exists = Array.from(teacherSelect.options).some(o => o.value === preservedValue);
            teacherSelect.value = exists ? preservedValue : '';
        }
    }

    // Filtre uygula
    function applyFilter() {
        const selected = teacherSelect.value;
        if (!allData || allData.length === 0) return;
        const headers = Object.keys(allData[0]);
        let nameKey = findNameKeyFromHeaders(headers) || guessNameKeyByHeuristic(allData) || headers[0];
        if (selected) {
            const filtered = allData.filter(r => String(r[nameKey] || '').trim() === selected);
            displayData(filtered.length ? filtered : allData);
            rowCountEl.textContent = 'Satır: ' + filtered.length;
        } else {
            displayData(allData);
            rowCountEl.textContent = 'Satır: ' + allData.length;
        }
    }

    // Veri çekme (cache-bypass)
    async function loadData() {
        try {
            const prevSelected = teacherSelect.value || '';
            const url = SHEET_URL + '&_=' + Date.now();
            const resp = await fetch(url, { cache: 'no-store' });
            if (!resp.ok) throw new Error('Sunucudan veri alınamadı: ' + resp.status);
            const txt = await resp.text();
            allData = parseCSV(txt);
            populateTeacherSelect(prevSelected);
            applyFilter();
            lastUpdatedEl.textContent = new Date().toLocaleString('tr-TR');
        } catch (err) {
            console.error('loadData hata:', err);
            resultsDiv.innerHTML = '<p>Veri yüklenirken hata oluştu. Konsolu kontrol et.</p>';
        }
    }

    // Eventler
    teacherSelect.addEventListener('change', applyFilter);
    refreshBtn.addEventListener('click', () => loadData());

    // Otomatik yenileme başlat
    function startAuto() {
        if (autoRefreshId) clearInterval(autoRefreshId);
        autoRefreshId = setInterval(loadData, autoRefreshSeconds * 1000);
    }

    // İlk yükleme
    window.addEventListener('load', () => {
        loadData();
        startAuto();
    });
    </script>
</body>
</html>
